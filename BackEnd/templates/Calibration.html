<!DOCTYPE html>
<html>
<head>
    <title>Calibration</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"> -->
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- <script src="{{ url_for('static', filename='JavaScript/sensor.js') }}"></script> -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='JavaScript/socket_connection.js') }}"></script> 
</head>
<body>
    
    <div class="container">
        <div class="mainabove-container">
            <!-- <a href="/logout">çıkış yap</a> -->
            <form method="get" action="/logout">
                <button type="submit" class="custom-button">
                    Eagleye AGA
                </button>
                <a href="#" class="custom-back-button" onclick="history.go(-1); return false;">
                    <img src="/static/images/back.svg">
                </a>
            </form>
        </div>
        <div class="mainbottom-container">
            <h1 class="title-text">Calibration</h1>
            <div style = "margin-top: -35px;">
                <div style="display: flex; align-items: center; justify-content: space-evenly;">
                    <label class="gas-label">GAS</label>
                    <label class="gas-label" style="width: 100%">OFFSET</label>
                    <label class="gas-label" style="width: 100%">READING</label>
                    <label class="gas-label" style="width: 100%">VALUE</label>
                    <label class="gas-label">ACTIONS</label>
                </div>
                <hr class="calibration-custom-hr"> <!-- Özelleştirilmiş HR etiketi -->
                <div style="display: flex; align-items: center; justify-content: space-evenly;">
                    <label class="gas-label">%CO </label>
                    <input class="input-calibration" id="CO_inputoffset" type="text" value="0" onclick="openNumpad('CO_inputoffset')">
                    <input class="input-calibration" id="CO_reading"type="text" value="0">
                    <input class="input-calibration" id="CO_value" type="text" value="0">
                    <button class="span-button" id="CObuttonspan" onclick="openPopuplabelView('CO_reading_popup')">SPAN</button>
                </div>
                <hr class="calibration-custom-hr"> <!-- Özelleştirilmiş HR etiketi -->
                <div style="display: flex; align-items: center; justify-content: space-evenly;">
                    <label class="gas-label">%CO2</label>
                    <input class="input-calibration" id="CO2_inputoffset" type="text" value="0" onclick="openNumpad('CO2_inputoffset')"> 
                    <input class="input-calibration" id="CO2_reading" type="text" value="0">
                    <input class="input-calibration" id="CO2_value" type="text" value="0">
                    <button class="span-button" id="CO2buttonspan" onclick="openPopuplabelView('CO2_reading_popup')">SPAN</button>
                </div>  
                <hr class="calibration-custom-hr"> <!-- Özelleştirilmiş HR etiketi -->
                <div style="display: flex; align-items: center; justify-content: space-evenly;">
                    <label class="gas-label">%CH4</label>
                    <input class="input-calibration" id="CH4_inputoffset" type="text" value="0" onclick="openNumpad('CH4_inputoffset')"> 
                    <input class="input-calibration" id="CH4_reading" type="text" value="0">
                    <input class="input-calibration" id="CH4_value" type="text" value="0">
                    <button class="span-button" id="CH4buttonspan" onclick="openPopuplabelView('CH4_reading_popup')">SPAN</button>
                </div>
                <hr class="calibration-custom-hr"> <!-- Özelleştirilmiş HR etiketi -->
            </div>
            <div id="keyboardContainer" class="popup"></div>
            <div id="spanpopup" class="spanpopup">
                <div class="spanpopup-content">
                    <h2 id="popUpTitle">Span Calibration</h2>

                    <label class="spanpopup-label" id="CO_reading_popup" style="display: none;">Live Span Value: <span id="CO_reading_popup" >0.00</span></label>
                    <label class="spanpopup-label" id="CO2_reading_popup" style="display: none;">Live Span Value: <span id="CO2_reading_popup">0.000</span></label>
                    <label class="spanpopup-label" id="CH4_reading_popup" style="display: none;">Live Span Value: <span id="CH4_reading_popup">0.00</span></label>
                    
                    <input class="spanpopup-input" type="text" id="spannewvalue" placeholder="Enter new value!" onclick="openNumpad('spannewvalue')">

                    <button id="calibratePopupButton">Calibrate</button>
                    <button id="closePopupButton">Close</button>
                </div>
            </div>
            <div>
                <div class="reset-content">
                    <label class="reset-label">Last Factory Calibration</label>
                    <button class="reset-button" type="button">RESET</button>
                    <button class="reset-zero" type="button">ZERO</button>
                </div>
                <button class="log-button" type="button">Show Calibration Logs</button>
            </div>
            <script>
                // var programStarted = false;
                var numpadInputCompleted = false;
                var isButtonClicked = false;
                document.addEventListener('DOMContentLoaded', function() {

                    var spanButtons = document.querySelectorAll('.span-button');
                    spanButtons.forEach(function (button) {
                        button.addEventListener('click', function () {
                            var buttonId = button.id;
                            // sendCalibrationRequest(buttonId);
                            openPopup(buttonId);
                        });
                    });

                    function openPopup() {
                        var popup = document.getElementById("spanpopup");
                        if (popup) {
                            popup.style.display = "block";
                        } else {
                            console.error("Popup element not found.");
                        }
                    }

                    var calibrateBtn = document.getElementById("calibratePopupButton");

                    if (calibrateBtn) {
                        calibrateBtn.addEventListener("click", function() {
                            isButtonClicked = true;
                            sendButtonClickStatusToServer(isButtonClicked);
                        });
                    } else {
                        console.error("calibrateBtn not found.");
                    }

                    function closePopup() {
                        var closeBt = document.getElementById("spanpopup");
                        if (closeBt) {
                            const clearspanvalue = document.getElementById("spannewvalue"); 
                            clearspanvalue.value = '';
                            closeBt.style.display = "none";
                        } else {
                            console.error("Popup element not found.");
                        }
                    }

                    closePopupButton.addEventListener('click', function () {
                        closePopup();
                    });

                    /// numpad açılıyor, inputId problemi
                       document.querySelectorAll('#CO_inputoffset, #CO2_inputoffset, #CH4_inputoffset').forEach(function(element) {
                        element.addEventListener('click', function() {
                            openNumpad(inputId);
                            document.getElementById("keyboardContainer").style.display = "none";
                        });
                    });

                    document.querySelectorAll('.spanpopup-input').forEach(function(element) {
                        element.addEventListener('click', function() {
                            document.querySelector('.numpad .enter').addEventListener('click', function () {
                                const Conc_cal = document.getElementById("spannewvalue").value; 
                                console.log('Conc_cal:',Conc_cal)
                                fetch('/update_conc_cal', { 
                                    method: 'POST', 
                                    headers: { 
                                        'Content-Type': 'application/json' 
                                    }, 
                                    body: JSON.stringify({ 
                                        conc_cal: Conc_cal, 
                                    }), 
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data);
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                });
                            });
                        });
                    });               
                });

                function openPopuplabelView(labelId) {
                    document.querySelectorAll('spanpopup').forEach(function(label) {
                        label.style.display = 'none';
                    });
                    const labelToShow = document.getElementById(labelId);
                    const popUpTitle = document.getElementById('popUpTitle');
                    console.log('title:',popUpTitle)
                    console.log('title:',labelToShow)
                    if (labelToShow) {
                        labelToShow.style.display = 'block';

                        const allLabels = document.querySelectorAll('.spanpopup-label');
                        allLabels.forEach(function (otherLabel) {
                            if (otherLabel !== labelToShow) {
                                otherLabel.style.display = 'none';
                            }
                        });
                    }
                }

                function sendButtonClickStatusToServer(status) {
                    fetch('/update_button_status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ buttonStatus: status })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }

                // let isRequestPending = false;
                // function sendCalibrationRequest(buttonId, action) {
                //     const popUpTitle = document.getElementById('popUpTitle');
                //     const buttonElement = document.getElementById(buttonId);
                //     const currentValueLabel = document.getElementById('currentValue');
                //     if (popUpTitle && buttonElement.id) {
                //         let calibrationType, sensorReading, decimalPlaces;

                //         // CalibrationType'ı belirle
                //         switch (buttonElement.id) {
                //             case 'CObuttonspan':
                //                 calibrationType = '%CO';
                //                 sensorReading = document.getElementById('CO_value').value;
                //                 decimalPlaces = 2;
                //                 break;
                //             case 'CO2buttonspan':
                //                 calibrationType = '%CO2';
                //                 sensorReading = document.getElementById('CO2_value').value;
                //                 decimalPlaces = 3;
                //                 break;
                //             case 'CH4buttonspan':
                //                 calibrationType = '%CH4';
                //                 sensorReading = document.getElementById('CH4_value').value;
                //                 decimalPlaces = 2;
                //                 break;
                //             default:
                //                 calibrationType = 'Unknown';
                //         }

                //         popUpTitle.textContent = `${calibrationType} Enter Span Value`;
                //         if (!isNaN(parseFloat(sensorReading))) {
                //             currentValueLabel.textContent = `${calibrationType} Live Span Value: ${parseFloat(sensorReading).toFixed(decimalPlaces)}`;
                //         } else {
                //             console.error('Invalid sensor data:', sensorReading);
                //         }                     
                //     }

                //     // JavaScript ile Flask endpoint'ine istek gönder
                //     if (isRequestPending) {
                //         console.log(`Request for ${buttonId} is already pending. Ignoring this request.`);
                //         isRequestPending = false;
                //         return;
                //     }
                //     isRequestPending = true;
                //     fetch('/start_calibration', { 
                //         method: 'POST', 
                //         headers: { 'Content-Type': 'application/json', 
                //         }, 
                //         body: JSON.stringify({ 
                //             buttonId, action 
                //         }) 
                //     })
                //     .then(response => {
                //         console.log('Network response:', response);
                //         if (!response.ok) {
                //             throw new Error('Network response was not ok');
                //         }
                //         return response.json();
                //     })
                //     .then(data => {
                //         console.log(`Response data for ${buttonId}:`, data);
                //     })
                //     .catch(error => {
                //         console.error('There was a problem with the fetch operation:', error);
                //     })
                //     .finally(() => {
                //         isRequestPending = false;
                //     });
                // }

                function openNumpad(inputId) {
                    document.getElementById("keyboardContainer").innerHTML = `{% include 'numpad.html' %}`;
                    const inputField = document.getElementById(inputId);
                    const labelField = document.getElementById("numpadLabel"); 
                    labelField.textContent = inputField.value;
                    let isLabelCleared = true;
                    
                    document.querySelectorAll('.numpad .key').forEach(key => {
                        key.addEventListener('click', function () {
                            const value = key.textContent;
                            key.classList.add("clicked");

                            if (inputField.value.charAt(0) === '0') {
                                // Başında "0" varsa, "0" karakterini kaldır
                                inputField.value = inputField.value.slice(1);3
                            }

                            if(!(value =="Enter" || value =="Space"|| value =="Clear" || value =="X")){
                                if (isLabelCleared) {
                                    // inputField.value = '';
                                    labelField.textContent = ''; // Numpad label'ını temizle
                                    isLabelCleared = false; // Bayrağı sıfırla
                                }
                                // inputField.value += value;  
                                labelField.textContent += value;
                            }
                            setTimeout(function () {
                                key.classList.remove("clicked");
                            }, 50);
                                                    
                        });
                    });

                    document.querySelector('.numpad .close').addEventListener('click', function () {
                        document.getElementById("keyboardContainer").style.display = "none";
                    });

                    // Enter tuşuna basıldığında
                    document.querySelector('.numpad .enter').addEventListener('click', function () {
                        numpadInputCompleted = true;
                        const labelField = document.getElementById("numpadLabel"); 
                        const new_value = labelField.textContent;
                        const inputField = document.getElementById(inputId);
                        const input_id = inputField.id;

                        // inputField.value = labelField.textContent;
                        if(input_id === 'CO_inputoffset' || input_id === 'CH4_inputoffset'){
                            inputField.value = parseFloat(labelField.textContent).toFixed(2);
                        }else if(input_id === 'CO2_inputoffset'){
                            inputField.value = parseFloat(labelField.textContent).toFixed(3);
                        }else if(input_id === 'spannewvalue'){
                            inputField.value = labelField.textContent;
                        }
                        if (new_value === '0' || input_id.value === '0') {
                            inputField.value ='0';
                        }

                        // if (input_id && new_value) {
                            // AJAX isteği ile Flask endpoint'ını çağır
                        fetch('/update_calibration_data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                input_id: input_id,  // Güncellenmesi istenen input alanının ID'si
                                new_value: new_value,
                            }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            // İsteğin başarılı olması durumunda yapılacak işlemler
                            console.log(data);
                        })
                        .catch(error => {
                            // İstekte hata olması durumunda yapılacak işlemler
                            console.error('Error:', error);
                        });
                        // } 
                        // else {
                        //     console.error('Invalid inputIdchange.');
                        // }

                        document.getElementById("keyboardContainer").style.display = "none";
                        isLabelCleared = false;
                    });
                    // "Clear" tuşuna basıldığında yapılacak işlemler
                    document.querySelector('.numpad .clear').addEventListener('click', function () {
                        //const inputId = "input-field"; // Buradaki inputId değerini kendi kullanımınıza göre değiştirin
                        // inputField.value = '0'; // Input alanını temizle
                        // labelField.textContent = '0';
                        labelField.textContent = '0';
                        const new_value = labelField.textContent;
                        const input_id = inputField.value;

                        if (input_id && new_value) {
                            // AJAX isteği ile Flask endpoint'ını çağır
                            fetch('/update_calibration_data', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    input_id: input_id,  // Güncellenmesi istenen input alanının ID'si
                                    new_value: new_value,
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                // İsteğin başarılı olması durumunda yapılacak işlemler
                                console.log(data);
                            })
                            .catch(error => {
                                // İstekte hata olması durumunda yapılacak işlemler
                                console.error('Error:', error);
                            });
                        } else {
                            console.error('Invalid inputIdchange.');
                        }
                    });
                    // Pop-up'ı görünür yap
                    document.getElementById("keyboardContainer").style.display = "block";
                }
                function closeKeyboard() {
                    // Pop-up'ı gizle
                    document.getElementById("keyboardContainer").style.display = "none";
                }
            </script>
        </div>
    </div>
</body>
</html>